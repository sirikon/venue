#!/usr/bin/env bash
set -euo pipefail

function main {
  trap 'true' SIGINT SIGTERM

  start-app &
  start-proxy &

  set +e
  wait -n
  exit_code="$?"
  set -e
  kill -s SIGINT -1
  wait
  exit "$exit_code"
}

function start-app {
  VENUE_WORKERS="${VENUE_WORKERS:-1}"
  VENUE_THREADS="${VENUE_THREADS:-1}"
  export PYTHONPATH="/app/src"
  exec /app/.venv/bin/python -m gunicorn \
    venue_site.wsgi:application \
    --bind=0.0.0.0:81 \
    --preload \
    --workers "${VENUE_WORKERS}" \
    --threads "${VENUE_THREADS}"
}

function start-proxy {
  exec caddy run --config /proxy/Caddyfile
}

main "$@"

#!/usr/bin/env bash
set -euo pipefail

/app/.venv/bin/python /app/src/manage.py check --deploy --fail-level WARNING

VENUE_WORKERS="${VENUE_WORKERS:-1}"
VENUE_THREADS="${VENUE_THREADS:-1}"
VENUE_PORT_PREFIX="${VENUE_PORT_PREFIX:-}"
export PYTHONPATH="/app/src"

exec /app/.venv/bin/granian \
  --interface wsgi \
  venue_django.wsgi:application \
  --host="0.0.0.0" \
  --port="${VENUE_PORT_PREFIX}80" \
  --workers "${VENUE_WORKERS}" \
  --blocking-threads "${VENUE_THREADS}" \
  --static-path-route "/static" \
  --static-path-mount "/app/static"
